+++
date = '2025-06-15T09:47:46+09:00'
draft = false
title = '【Ruby on Rails】レンタカー利用予約システム'
summary = '２年次後期の演習課題として、Ruby on Railsを利用したWebアプリを制作しました。設計はグループで、実装は各個人で行う形式。MVCモデル大好き。'
thumbnail = 'thumbnail.png'
+++
## 制作内容
### 成果物
- Webアプリケーション  
Ruby on Railsを利用したWebアプリが最終的な成果物。  
レンタカー(カーシェア)の予約システムを開発しました。

#### 動作画面（約5分）
{{<video src="2025-06-15 15-10-24.mp4" fallback="動画が再生できません">}}

顧客ログイン・予約登録→  
管理者ログイン・予約一覧→  
店舗・オプション・車両追加

### 制作期間
- １〜２ヶ月  
２年次後期の後半１〜２ヶ月間で、設計〜実装〜テストを行いました。

## 使用技術
- Ruby(Ruby on Rails)  
Ruby(言語)というより、Ruby on Rails(フレームワーク)を利用しました。

- Docker  
今回は単体のDockerコンテナを利用しました。つまり、DBはRailsデフォルトのSQLiteを利用し、プロキシサーバも利用していません。  
環境ファイルは担当教授・講師の方が用意してくださったものを利用しています。受講者全員が全く同じ環境を利用したということです。

- Draw.io  
モデリングに利用。Google Driveにファイル本体を置き、グループメンバーで共同編集しながら設計・設計評価を行いました。

## 動機
### 授業の一環
この制作は、動機という動機はありません。**作らねば必修科目を修得できない**だけのことです。  

私はWebシステムを作れるようになりたいと思い専攻選択をしたため、喜んで授業や課題に取り組みました。  
この課題を通して、MVCモデルのフレームワークの扱い方を学べました。これ以前より、PHPのLaravelを触っていたので概念的には知っていましたが、これで１つのアプリの全機能を動くようにしたのは初めてでした。この経験は、自分の自信にも繋がっていると思います。

## その他説明
### 設計
企画・設計はグループで行いました。
#### ユースケース  
ユースケースでは、考えられるリソース関連の操作を片っ端から挙げていきました。  
基本的には、リソースのほぼ全てに対してCRUD機能を実装することを想定しています。
{{<enlarge src="usecase.drawio.png" alt="ユースケース図">}}

「ユースケースってこういうことなのか？」と疑問でしたが、片っ端から書けという指示もあり、縦に広がっていきました。  
記事執筆時点だからこそ言えますが、今回はとにかく**実装する範囲を明確にする**ということが目的だったと思うので、粒度としては適切の範囲内だと思います。  
とはいえ、これくらいになってくると、アクター毎に分けて示すとかの工夫があっても良いですね。

#### ER図  
必要なテーブルやカラム、関連付けといったテーブル構造を考えていきました。  
{{<enlarge src="er.drawio.png" alt="ER図">}}

本来であればテーブル名で考えるべきですが、ここではモデル名基準で構造を考えているみたいですね。  
Memberモデルのexpiration_dateは免許証有効期限です。最終的に、「ユーザ登録時に有効であるかは確認するが、サービス利用時に有効かどうかは求めない」という信用方式での実装となりました。  
また、Inquiryは顧客→店舗への連絡(問い合わせ)、Messageは店舗→顧客への連絡用のテーブルとなります。

#### 画面遷移図  
画面遷移のモデリングです。どの画面からどの画面へ飛べるのかを洗い出しています。  
{{<enlarge src="views.drawio.png" alt="画面遷移図">}}

ヘッダーから飛ぶことは考慮せずに書いています。本来であれば書いておくべきな気もしますが、そこまで頭が回っていなかったか、「ヘッダーは全ページの共通レイアウトだからわざわざ書く必要はない」と割り切ったのかもしれません。制作から半年経った今、真相は闇の中です。

### 実装
GitHub URL: https://github.com/kinoha-1173/NS-rorcar
#### 予約登録機能の苦悩
**予約機能の実装に最も苦しめられた**記憶があります。  
リソースの関連付けと画面での操作の関係がゴチャゴチャになっていたことが原因だったと考えています。  
テーブル構造としては、「parkings --< cars --< reservations」の関係となります。右に行くほど"多"になります。  
この流れであれば、画面は「パーキングにある車を選択してから、いよいよ予約画面へ」というのが自然だと思います。ですが、このアプリは「パーキングを選択すると予約画面へ」という画面遷移をしています。これは、[タイムズカーシェア](https://share.timescar.jp/)を参考にしたためです。

ここで問題となるのは、**予約画面のルートはどこにネストするべきか**ということです。予約は車両と直接結びつくため、Carリソースのルートにネストさせたいところですが、予約画面に遷移した時点では利用車両が定まっていません。だからといって、Reservationリソースとして独立させると利用店舗(Parking)がどこか分からなくなってしまいます。そのため、予約画面へのルートはParkingリソースのルートにネストされました。  

そして、次は入力内容確認画面です。ルートとしては、先程のネスト内に`POST：confirm`ルートを通しただけの、簡単そうなお仕事です。しかし、初Railsです。このルートへの飛ばし方が分からなかったのです。  
最終的な実装として、引数`url`により明示的に遷移先を指定することで乗り越えました。まず、予約画面(`new.html.erb`)では、以下のようにして入力確認画面へ遷移させます。  
```ruby
<%= form_for @reservation, url: [:confirm, @parking, :reservation] do |form| %>
```
遷移先の画面を描画する前に、コントローラでモデルを作成してしまいます。この時点で一度バリデーションを行い、不正・不可能な入力を検知します。  
```ruby
def confirm
    @member = current_member
    @parking = Parking.find(params[:parking_id])
    @reservation = Reservation.new(params[:reservation])
    @usage = (@reservation.end_on - @reservation.started_on) / 1800 * 480
    params[:reservation][:option_ids].each do |option_id|
        next if option_id.blank?
        option = Option.find(option_id.to_i)
        @usage += option.price
    end
    @reservation.assign_attributes(member_id: current_member.id, fee: @usage)
    if !@reservation.valid?
        ...
    end
end
```
そして、確認画面のレンダリングを行います。ここでもフォームの遷移先を同じ様に指定していきます。  
```ruby
<%= form_for @reservation, url: [@parking, :reservation], method: :post do |form| %>
    <%= form.hidden_field :car_id %>
    <%= form.hidden_field :started_on %>
    <%= form.hidden_field :end_on %>
    <%= form.hidden_field :fee %>
    <% @reservation.option_ids.each do |option_id| %>
    <%= form.hidden_field :option_ids, {multiple: true, value: option_id} %>
    <% end %>
    <table class="info">
        <tr>
            <th>予約車両</th>
            ...
        </tr>
        ...
    </table>
<% end %>
```  
この画面からデータを引き継がせる、特に「選択したオプション」も次のコントローラメソッドに引き継ぐために、`hidden`フィールドを利用しています。実装当時も感じていましたが、納期に迫られ血迷った選択だと思います。

## 展望・改善点
### リソース志向の設計・実装
この制作を通して、リソースベースでの実装について理解が深まりました。リソースという概念の基での実装は、非常に効率的だと思います。  
個人的に、Laravelよりもかなりリソース志向が強いと感じました。その分、学習コストもLaravelより低いと思いますし、フレームワークのはじめの一歩として優秀だと思います。

### フロントエンドの切り出し
今回の構成では、全てをRubyコンテナ内で完結させているため、構成レベルの窮屈さがあります。もちろん、このコンテナ内にNodeを入れて、TailwindCSSやReactなどを適用することもできるでしょうが、少し窮屈です。Railsを完全なAPIサーバ、他コンテナをフロント用サーバとして、責務分離をやった構成にも挑戦したいところです。

### 不具合・異常修正
動画を撮影していて見つけたのですが、利用予約時に出される「車両一覧」が適切ではないです。違う店舗の車両も含め全て出されていたり、フォーマットが崩れたりしています。  
{{<enlarge src="cars-noprop.png" alt="予約画面の切り抜き">}}

こういったことをテスト時に見抜いて、修正できるようにしなければなりません。これから開発するときには、あらゆるテストケースを考え、見逃さないようにします。
